<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <title>abå°±è¿™æ ·fuckå…¨å®‡å®™å§</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>

    <style>
        /* ğŸ¨ å…¨å±€ CSS å˜é‡ä¸­æ¢ */
        :root {
            --mint-dark: #A3C9B8;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: rgba(0, 0, 0, 0.04);
            --text-main: #2C3E50;
            --msg-user: rgba(255, 255, 255, 0.6);
            --msg-ai: rgba(255, 255, 255, 0.9);
            --active-color: rgba(255, 255, 255, 0.95);
            --active-text: #000000;
        }

        body.dark-ui {
            --glass-bg: rgba(0, 0, 0, 0.45);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: rgba(0, 0, 0, 0.3);
            --text-main: #F3F4F6;
            --msg-user: rgba(255, 255, 255, 0.1);
            --msg-ai: rgba(0, 0, 0, 0.7);
            --active-color: rgba(0, 0, 0, 0.85);
            --active-text: #FFFFFF;
        }

        #bg-layer { position: fixed; inset: 0; z-index: -1; background: linear-gradient(135deg, #FFFFFF 0%, #F0F4F8 100%); background-size: cover; background-position: center; transition: background 0.5s ease; }
        body.dark-ui #bg-layer { background: linear-gradient(135deg, #0F172A 0%, #020617 100%); }

        body { color: var(--text-main); font-family: 'Segoe UI', 'PingFang SC', sans-serif; height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); overflow: hidden; user-select: none; -webkit-user-select: none; transition: color 0.3s ease; }

        .glass { background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px var(--glass-shadow); transition: background 0.3s ease, border 0.3s ease; }
        
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 0.9rem; user-select: text; -webkit-user-select: text; word-break: break-word; transition: background 0.3s ease; }
        .user-msg { background: var(--msg-user); align-self: flex-end; }
        .ai-msg { background: var(--msg-ai); align-self: flex-start; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .typing-indicator::after { content: '.'; animation: typing 1.5s infinite steps(4, end); }
        @keyframes typing { 0%, 100% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

        .btn-action { transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); color: var(--text-main); }
        .btn-action:hover { transform: translateY(-2px) scale(1.02); background: var(--glass-border); }
        .nav-active { background: var(--active-color) !important; color: var(--active-text) !important; box-shadow: 0 4px 20px var(--glass-shadow); }
        .mode-tab { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.3s; opacity: 0.6; }
        .mode-tab.active { opacity: 1; background: var(--active-color); color: var(--active-text); box-shadow: 0 2px 10px var(--glass-shadow); }

        #canvasContainer::after { content: ''; position: absolute; left: 50%; top: 15%; bottom: 15%; width: 1.5px; background: linear-gradient(to bottom, transparent, var(--glass-border), transparent); pointer-events: none; transition: opacity 0.3s ease; }
        .canvas-locked::after { background: linear-gradient(to bottom, transparent, rgba(255,0,0,0.4), transparent) !important; }
        #drawCanvas { touch-action: none; }
        .brush-select { border: 2px solid var(--mint-dark) !important; background: var(--glass-border) !important; }

        input, textarea, select { user-select: auto; -webkit-user-select: auto; color: var(--text-main); }
        input::placeholder, textarea::placeholder { color: var(--text-main); opacity: 0.5; }
        option { background: #FFFFFF; color: #000000; }
        body.dark-ui option { background: #1A1A1A; color: #FFFFFF; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }

        @media (pointer: fine) { body, button, input, textarea, select, #drawCanvas { cursor: none !important; } }
        @media (pointer: coarse) { .cursor-dot, .cursor-outline { display: none !important; } }
        .cursor-dot, .cursor-outline { position: fixed; top: 0; left: 0; border-radius: 50%; z-index: 9999; pointer-events: none; }
        .cursor-dot { width: 8px; height: 8px; background-color: var(--mint-dark); box-shadow: 0 0 10px var(--mint-dark); transform: translate(-50%, -50%); transition: background 0.3s ease;}
        .cursor-outline { width: 40px; height: 40px; border: 2px solid var(--glass-border); background: rgba(255,255,255,0.1); backdrop-filter: blur(2px); transform: translate(-50%, -50%); transition: width 0.3s ease, height 0.3s ease, background 0.3s ease, border-color 0.3s ease; }
        .cursor-hover .cursor-outline { width: 65px; height: 65px; background: var(--glass-bg); border-color: var(--mint-dark); }
        .cursor-hover .cursor-dot { opacity: 0; transition: opacity 0.2s; }

        /* ğŸ“š ä¿®å¤é˜²é®æŒ¡çš„æ ¸å¿ƒï¼špointer-events é­”æ³• */
        .book-wrapper { position: relative; overflow: hidden; transition: background 0.3s ease, color 0.3s ease; }
        .book-content { transition: transform 0.25s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.25s ease; font-size: 16px; line-height: 2.2; letter-spacing: 0.05em; text-align: justify; padding-bottom: 80px; }
        .theme-glass { background: var(--glass-bg); color: var(--text-main); }
        .theme-parchment { background: #F4ECD8 !important; color: #5C4033 !important; box-shadow: inset 0 0 40px rgba(139, 69, 19, 0.1); border:none; }
        .theme-dark { background: #1A1A1A !important; color: #D4D4D4 !important; border:none; }
        .theme-sakura { background: #FFF0F5 !important; color: #8B5A2B !important; border:none; }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: var(--mint-dark); } 
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; }

        #pdfLoading { position: absolute; inset: 0; background: var(--glass-bg); backdrop-filter: blur(10px); z-index: 50; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; display: none; }
#pdfLoading:not(.hidden) { display: flex; pointer-events: auto; }

        /* ğŸ§šâ€â™€ï¸ æ‚¬æµ®æ°”æ³¡ä¿®å¤é˜²é®æŒ¡ */
        .roast-bubble {
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); padding: 10px 16px; border-radius: 20px;
            border-bottom-right-radius: 2px; max-width: 220px; font-size: 0.85rem;
            margin-bottom: 8px; opacity: 0; transform: translateY(10px) scale(0.9);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 25px var(--glass-shadow); pointer-events: none; /* ç©¿é€ä¸é®æŒ¡ */
            color: var(--text-main); font-weight: bold; line-height: 1.4;
        }
        .roast-bubble.show { opacity: 1; transform: translateY(0) scale(1); }
        .drawer-slide { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .drawer-slide.open { transform: translateX(0); }

        /* ğŸ² é£è¡Œæ£‹ä¸“å±æ ·å¼ */
        .chess-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; width: 100%; max-width: 400px; margin: 0 auto; }
        .chess-cell { aspect-ratio: 1; border-radius: 12px; border: 2px solid var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; opacity: 0.8; position: relative; transition: all 0.3s; }
        .chess-cell.start { background: rgba(163, 201, 184, 0.4); border-color: var(--mint-dark); }
        .chess-cell.end { background: rgba(255, 100, 100, 0.3); border-color: #ff6b6b; }
        .player-token, .ai-token { position: absolute; width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 10; }
        .player-token { background: var(--text-main); border: 2px solid white; transform: translate(-5px, -5px); }
        .ai-token { background: var(--mint-dark); border: 2px solid white; transform: translate(5px, 5px); }
        .dice-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto; cursor: pointer; background: var(--active-color); color: var(--active-text); box-shadow: 0 8px 20px var(--glass-shadow); transition: transform 0.1s; }
        .dice-btn:active { transform: scale(0.9); }
        .dice-rolling { animation: roll 0.5s infinite linear; pointer-events: none; }
        @keyframes roll { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col">
    <div id="bg-layer"></div>
    <div class="cursor-dot" id="cursorDot"></div>
    <div class="cursor-outline" id="cursorOutline"></div>

    <header class="glass m-4 mb-2 rounded-3xl p-3 flex justify-between items-center shrink-0 z-30">
        <div class="flex items-center space-x-2 pl-2">
            <div class="w-3 h-3 rounded-full animate-pulse" style="background-color: var(--mint-dark);"></div>
            <h1 class="text-sm font-bold tracking-[0.2em] opacity-80 uppercase">ab fuck world</h1>
        </div>
        <nav class="flex space-x-1 p-1 bg-white/10 rounded-full border border-white/20">
            <button onclick="switchTab('readTab')" id="nav-read" class="btn-action px-3 md:px-5 py-2 text-[10px] md:text-xs font-semibold rounded-full">é˜…è¯»</button>
            <button onclick="switchTab('drawTab')" id="nav-draw" class="btn-action px-3 md:px-5 py-2 text-[10px] md:text-xs font-semibold rounded-full">ç”»æ¿</button>
            <button onclick="switchTab('chessTab')" id="nav-chess" class="btn-action px-3 md:px-5 py-2 text-[10px] md:text-xs font-semibold rounded-full">é£è¡Œæ£‹</button>
            <button onclick="switchTab('settingTab')" id="nav-set" class="btn-action px-3 md:px-5 py-2 text-[10px] md:text-xs font-semibold rounded-full">é…ç½®</button>
        </nav>
    </header>

    <main class="flex-1 relative p-4 pt-0">
        
        <section id="settingTab" class="absolute inset-0 p-4 flex items-center justify-center hidden overflow-y-auto z-10">
            <div class="glass w-full max-w-xl p-8 rounded-[40px] space-y-4 text-center my-auto">
                <div class="text-2xl mb-2">âœ¨</div>
                <div class="flex justify-between items-center bg-white/10 p-3 rounded-2xl mb-2 border border-white/20">
                    <div class="flex flex-col items-start w-1/3">
                        <span class="text-[10px] font-bold opacity-80 mb-1">ç”»å»Šå£çº¸</span>
                        <div class="flex space-x-1">
                            <input type="file" id="wallpaperInput" accept="image/*" class="hidden" onchange="handleWallpaperUpload(event)">
                            <button onclick="document.getElementById('wallpaperInput').click()" class="text-[10px] bg-white/20 px-2 py-1 rounded-full hover:bg-white/40">ä¸Šä¼ </button>
                            <button onclick="clearWallpaper()" class="text-[10px] bg-red-400/20 text-red-500 font-bold px-2 py-1 rounded-full">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="flex flex-col items-center w-1/3 border-l border-r border-white/20 px-2">
                        <span class="text-[10px] font-bold opacity-80 mb-1">AI å¤´åƒ</span>
                        <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="handleAvatarUpload(event)">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('avatarInput').click()">
                            <img id="settingAvatarPreview" src="" class="w-8 h-8 rounded-full border-2 border-white/50 object-cover shadow-sm transition group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><span class="text-[8px] text-white">æ›´æ¢</span></div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end w-1/3">
                        <span class="text-[10px] font-bold opacity-80 mb-1">é¢„è®¾æ¨¡å¼</span>
                        <button onclick="toggleDarkUI()" class="text-[10px] bg-white/20 px-3 py-1 rounded-full hover:bg-white/40">ğŸŒ“ æ·±æµ…è‰²</button>
                    </div>
                </div>

                <div class="border border-white/20 bg-white/5 rounded-2xl p-3 mb-4">
                    <span class="text-[11px] font-bold opacity-70 mb-2 block tracking-wider">ğŸ¨ PROçº§è°ƒè‰²ç›˜</span>
                    <div class="flex justify-around items-center">
                        <div class="flex flex-col items-center"><input type="color" id="color-primary" value="#A3C9B8" oninput="applyCustomColor('primary', this.value)" class="w-8 h-8 rounded-full border-0 p-0 bg-transparent cursor-pointer"><span class="text-[9px] mt-1 font-bold opacity-60">UIä¸»è‰²</span></div>
                        <div class="flex flex-col items-center"><input type="color" id="color-bg" value="#F0F4F8" oninput="applyCustomColor('bg', this.value)" class="w-8 h-8 rounded-full border-0 p-0 bg-transparent cursor-pointer"><span class="text-[9px] mt-1 font-bold opacity-60">çº¯è‰²åº•</span></div>
                        <div class="flex flex-col items-center"><input type="color" id="color-border" value="#ffffff" oninput="applyCustomColor('border', this.value)" class="w-8 h-8 rounded-full border-0 p-0 bg-transparent cursor-pointer"><span class="text-[9px] mt-1 font-bold opacity-60">è¾¹æ¡†è‰²</span></div>
                        <div class="flex flex-col items-center"><input type="color" id="color-text" value="#2C3E50" oninput="applyCustomColor('text', this.value)" class="w-8 h-8 rounded-full border-0 p-0 bg-transparent cursor-pointer"><span class="text-[9px] mt-1 font-bold opacity-60">å­—ä½“è‰²</span></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="apiUrl" placeholder="Proxy Base URL" class="w-full bg-white/10 border-0 rounded-2xl p-3 text-sm outline-none">
                    <input type="password" id="apiKey" placeholder="API Key" class="w-full bg-white/10 border-0 rounded-2xl p-3 text-sm outline-none">
                </div>
                <input type="text" id="modelName" placeholder="Model Name" class="w-full bg-white/10 border-0 rounded-2xl p-3 text-sm outline-none">
                <textarea id="persona" rows="2" placeholder="AI æ€§æ ¼è®¾å®š..." class="w-full bg-white/10 border-0 rounded-2xl p-3 text-sm outline-none"></textarea>
                <div class="border-t border-white/20 pt-4 mt-2 text-left">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold opacity-70 uppercase tracking-tighter">ğŸ§  Core Memory</span>
                        <button onclick="forceSummarize()" class="text-[10px] bg-white/20 px-2 py-1 rounded">å¼ºåˆ¶æ€»ç»“</button>
                    </div>
                    <textarea id="coreMemory" rows="2" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-xs outline-none transition"></textarea>
                    <div class="flex justify-between items-center mb-2 mt-3">
                        <span class="text-xs font-bold opacity-70 uppercase tracking-tighter">ğŸ“œ History Log</span>
                        <button onclick="clearContext()" class="text-[10px] bg-red-400/30 text-red-500 font-bold px-2 py-1 rounded">æ¸…ç©ºå¤±å¿†</button>
                    </div>
                    <textarea id="chatContext" rows="2" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-[10px] outline-none font-mono transition"></textarea>
                </div>
                <button onclick="saveSettings()" class="w-full py-3 mt-2 rounded-2xl font-bold shadow-lg transition hover:opacity-80 border border-white/30" style="background: var(--active-color); color: var(--active-text);">æ³¨å…¥çµé­‚</button>
            </div>
        </section>

        <section id="readTab" class="absolute inset-0 hidden overflow-hidden rounded-[32px] z-10">
            <div id="readerWrapper" class="w-full h-full flex flex-col book-wrapper theme-glass glass relative">
                <div id="pdfLoading" class="hidden"><div class="text-4xl mb-4 animate-bounce">ğŸ“š</div><div>æ­£åœ¨åš¼ç¢ PDF...</div><div id="pdfProgress" class="text-xs font-normal opacity-70 mt-2">0%</div></div>

                <div class="p-4 border-b border-white/10 flex justify-between items-center relative z-20">
                    <input type="file" accept=".txt, .pdf" class="text-[10px] uppercase tracking-widest opacity-40 w-32" onchange="loadBook(event)">
                    <div class="flex items-center space-x-4">
                        <span id="pageIndicator" class="text-[10px] opacity-40 tracking-widest font-bold">PAGE 0 / 0</span>
                        <button onclick="toggleReaderSettings()" class="text-sm font-bold opacity-60 hover:opacity-100 transition tracking-tighter">Aa</button>
                    </div>
                    <div id="readerSettingsPanel" class="absolute top-14 right-4 glass p-4 rounded-2xl hidden z-50 flex flex-col space-y-4 shadow-2xl border border-white/20 w-56">
                        <div class="flex items-center justify-between space-x-4 bg-white/10 rounded-full px-3 py-1"><button onclick="changeFontSize(-2)" class="text-sm font-bold hover:opacity-70">A-</button><span id="fontSizeDisplay" class="text-[11px] font-bold opacity-50">16px</span><button onclick="changeFontSize(2)" class="text-lg font-bold hover:opacity-70">A+</button></div>
                        <div class="flex items-center space-x-3 justify-center">
                            <div onclick="changeTheme('glass')" class="color-dot active" style="background: linear-gradient(135deg, #e0e0e0, #ffffff);"></div><div onclick="changeTheme('parchment')" class="color-dot" style="background: #F4ECD8;"></div><div onclick="changeTheme('dark')" class="color-dot" style="background: #1A1A1A;"></div><div onclick="changeTheme('sakura')" class="color-dot" style="background: #FFF0F5;"></div>
                        </div>
                        <div class="w-full h-px bg-white/20 my-1"></div>
                        <div class="text-[10px] font-bold opacity-60 text-center uppercase tracking-widest">AI ä¼´è¯»é¢‘ç‡</div>
                        <select id="roastMode" onchange="applyRoastSettings()" class="w-full bg-white/10 border border-white/20 rounded-lg p-1 text-xs outline-none">
                            <option value="fixed">ğŸ“– å›ºå®šç¿»é¡µ</option><option value="random">ğŸ² éšæœºè§¦å‘</option><option value="time">â±ï¸ å®šæ—¶è‡ªåŠ¨</option><option value="manual">ğŸ”• ä»…æ‰‹åŠ¨</option>
                        </select>
                        <div id="wrap-roast-fixed" class="flex items-center justify-between mt-1 hidden"><span class="text-[10px] opacity-70">é—´éš”é¡µæ•°:</span><input type="number" id="roastFixedPages" value="5" min="1" max="30" class="w-12 bg-white/20 rounded px-1 text-center text-xs outline-none" onchange="applyRoastSettings()"></div>
                        <div id="wrap-roast-random" class="flex items-center justify-between mt-1 hidden"><span class="text-[10px] opacity-70">æ¦‚ç‡(%):</span><input type="number" id="roastRandomProb" value="30" min="1" max="100" class="w-12 bg-white/20 rounded px-1 text-center text-xs outline-none" onchange="applyRoastSettings()"></div>
                        <div id="wrap-roast-time" class="flex items-center justify-between mt-1 hidden"><span class="text-[10px] opacity-70">é—´éš”ç§’:</span><input type="number" id="roastTimeSeconds" value="60" min="10" max="600" class="w-12 bg-white/20 rounded px-1 text-center text-xs outline-none" onchange="applyRoastSettings()"></div>
                    </div>
                </div>

                <div class="flex-1 relative overflow-hidden"><div id="bookContent" class="absolute inset-0 p-8 overflow-y-auto book-content no-scrollbar"></div></div>
                
                <div class="absolute bottom-6 left-0 right-0 flex justify-center space-x-16 bg-transparent z-10 pointer-events-none">
                    <button onclick="turnPage(-1)" class="pointer-events-auto btn-action w-12 h-12 rounded-full border border-white/30 flex items-center justify-center text-xl hover:bg-white/20 backdrop-blur-md transition shadow-sm">â†</button>
                    <button onclick="turnPage(1)" class="pointer-events-auto btn-action w-12 h-12 rounded-full border border-white/30 flex items-center justify-center text-xl hover:bg-white/20 backdrop-blur-md transition shadow-sm">â†’</button>
                </div>
            </div>

            <div id="readAvatarContainer" class="absolute right-6 bottom-6 z-50 flex flex-col items-end pointer-events-none">
                <div id="roastBubble" class="roast-bubble"></div>
                <div class="relative pointer-events-auto">
                    <div class="absolute inset-0 rounded-full animate-ping opacity-30" style="background-color: var(--mint-dark);"></div>
                    <img id="floatingAvatar" src="" class="w-14 h-14 rounded-full border-2 border-white/60 shadow-xl cursor-pointer object-cover relative z-10 hover:scale-110 transition duration-300" onclick="toggleReadChatDrawer()">
                </div>
            </div>

            <div id="readChatDrawer" class="absolute right-0 top-0 bottom-0 w-full md:w-96 glass border-l border-white/20 drawer-slide z-40 flex flex-col">
                <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/5">
                    <div class="flex items-center space-x-2"><img id="drawerAvatar" src="" class="w-6 h-6 rounded-full object-cover hidden"><span class="font-bold text-sm opacity-80">æ‚„æ‚„è¯</span></div>
                    <button onclick="toggleReadChatDrawer()" class="text-xl font-bold opacity-60 hover:opacity-100 transition px-2">Ã—</button>
                </div>
                <div id="readChatBox" class="flex-1 overflow-y-auto p-5 flex flex-col space-y-4 no-scrollbar"></div>
                <div class="p-3 bg-white/5 flex space-x-2 border-t border-white/10 backdrop-blur-md">
                    <input type="text" id="readInput" placeholder="å’Œæˆ‘è¯´ç‚¹ä»€ä¹ˆ..." class="flex-1 bg-white/10 border border-white/20 rounded-xl px-3 text-sm outline-none">
                    <button onclick="sendManualChat('read')" class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg transition hover:opacity-80" style="background: var(--active-color); color: var(--active-text);">â†‘</button>
                </div>
            </div>
        </section>

        <section id="drawTab" class="absolute inset-0 flex flex-col md:flex-row gap-4 hidden pt-2 z-10">
            <div class="flex-1 glass rounded-[32px] overflow-hidden relative flex flex-col">
                <div class="flex justify-center mt-3 mb-1 space-x-2 z-20">
                    <div id="mode-free" onclick="setGameMode('free')" class="mode-tab active bg-white/20">âœ¨ è‡ªç”±å…±ç»˜</div>
                    <div id="mode-guess" onclick="setGameMode('guess')" class="mode-tab bg-white/20">â“ ä½ ç”»æˆ‘çŒœ</div>
                    <div id="mode-blind" onclick="setGameMode('blind')" class="mode-tab bg-white/20">ğŸ™ˆ åŒäººç›²ç»˜</div>
                </div>
                <div class="glass mx-auto px-4 py-2 rounded-full flex items-center space-x-3 z-20 w-[95%] md:w-auto overflow-x-auto justify-between shadow-sm border border-white/20">
                    <div class="flex items-center space-x-1 border-r border-white/20 pr-3 shrink-0">
                        <input type="color" id="colorPicker" value="#000000" class="w-5 h-5 rounded-full border-0 p-0 bg-transparent cursor-pointer mr-1">
                        <button id="btn-pen" onclick="setTool('pen')" class="btn-action px-2 py-1 text-[10px] font-bold rounded-full brush-select">PEN</button>
                        <button id="btn-pencil" onclick="setTool('pencil')" class="btn-action px-2 py-1 text-[10px] font-bold rounded-full">PENCIL</button>
                        <button id="btn-eraser" onclick="setTool('eraser')" class="btn-action px-2 py-1 text-[10px] font-bold rounded-full">ERASE</button>
                        <button onclick="undo()" class="btn-action w-6 h-6 rounded-full glass flex items-center justify-center text-xs ml-1 hover:bg-white/20">â†©</button>
                        <button onclick="clearCanvas()" class="btn-action px-2 py-1 text-[10px] opacity-70 hover:opacity-100 font-bold ml-1 text-red-400">RESET</button>
                    </div>

                    <div id="panel-free" class="flex items-center space-x-2 shrink-0">
                        <select id="drawStyle" class="bg-white/20 border border-white/20 rounded-full px-2 py-1 text-[10px] outline-none font-bold">
                            <option value="companion">ğŸ§¸ é™ªä¼´ä½œç”»</option><option value="connect">ğŸ§© æ¥åŠ›æ‹¼å›¾</option>
                        </select>
                        <button onclick="submitFreeDraw()" class="btn-action px-4 py-1 text-[11px] font-bold rounded-full" style="background: var(--active-color); color: var(--active-text);">äº¤å·</button>
                    </div>
                    <div id="panel-guess" class="flex space-x-2 shrink-0 hidden"><button onclick="submitGuessUser()" class="btn-action px-3 py-1 text-[11px] bg-white/30 font-bold rounded-full">æˆ‘ç”»,AIçŒœ</button><button onclick="submitGuessAI()" class="btn-action px-3 py-1 text-[11px] font-bold rounded-full" style="background: var(--active-color); color: var(--active-text);">AIç”»,æˆ‘çŒœ</button></div>
                    <div id="panel-blind" class="flex items-center space-x-2 shrink-0 hidden"><input type="text" id="blindTopic" placeholder="ä¸»é¢˜..." class="w-16 bg-white/20 border-0 rounded-full px-2 py-1 text-[10px] outline-none"><input type="number" id="blindTimeInput" value="60" class="w-10 bg-white/20 border-0 rounded-full px-2 py-1 text-[10px] outline-none text-center"><button id="btn-start-blind" onclick="startBlindDraw()" class="btn-action px-3 py-1 text-[11px] font-bold rounded-full" style="background: var(--active-color); color: var(--active-text);">å¼€å§‹</button><span id="blindTimer" class="text-xs font-bold text-red-500 hidden">60s</span><button id="btn-reveal-blind" onclick="revealBlindDraw()" class="btn-action px-3 py-1 text-[11px] bg-red-400 text-white font-bold rounded-full hidden">æ­æ™“</button></div>
                </div>
                <div class="flex-1 w-full" id="canvasContainer"><canvas id="drawCanvas" class="w-full h-full"></canvas></div>
            </div>
            
            <div class="w-full h-[35vh] md:h-auto md:w-80 glass rounded-[32px] overflow-hidden flex flex-col shrink-0">
                <div id="drawChatBox" class="flex-1 overflow-y-auto p-5 flex flex-col space-y-4 no-scrollbar"></div>
                <div class="p-3 bg-white/10 flex space-x-2 border-t border-white/10">
                    <input type="text" id="drawPrompt" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." class="flex-1 bg-transparent border-0 outline-none px-2 text-sm">
                    <button onclick="sendManualChat('draw')" class="w-10 h-10 rounded-2xl flex items-center justify-center shadow-lg transition hover:opacity-80" style="background: var(--active-color); color: var(--active-text);">â†‘</button>
                </div>
            </div>
        </section>

        <section id="chessTab" class="absolute inset-0 flex flex-col md:flex-row gap-4 hidden pt-2 z-10">
            <div class="flex-1 glass rounded-[32px] overflow-hidden relative flex flex-col items-center justify-center p-6">
                <div id="chessBoard" class="chess-grid">
                    </div>
                
                <div class="mt-8 flex flex-col items-center space-y-4">
                    <div id="dice" class="dice-btn" onclick="rollDice()">ğŸ²</div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full border-2 border-white" style="background: var(--text-main);"></div><span class="text-xs font-bold">ä½ </span></div>
                        <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full border-2 border-white" style="background: var(--mint-dark);"></div><span class="text-xs font-bold">AI</span></div>
                        <button onclick="resetChess()" class="text-[10px] bg-white/20 px-3 py-1 rounded-full hover:bg-white/40 ml-4">é‡ç½®æ£‹å±€</button>
                    </div>
                </div>
            </div>
            
            <div class="w-full h-[35vh] md:h-auto md:w-80 glass rounded-[32px] overflow-hidden flex flex-col shrink-0">
                <div class="p-3 bg-black/10 border-b border-white/10 font-bold text-center text-sm opacity-80 uppercase tracking-widest">Game Master Log</div>
                <div id="chessChatBox" class="flex-1 overflow-y-auto p-5 flex flex-col space-y-4 no-scrollbar">
                    <div class="chat-bubble ai-msg text-sm">âœ¨ æ¬¢è¿æ¥åˆ°èµ›åšé£è¡Œæ£‹ï¼æ·å‡ºéª°å­ï¼Œæ¥å—å‘½è¿æ¶©æ¶©çš„å®‰æ’å§ï¼</div>
                </div>
                <div class="p-3 bg-white/10 flex space-x-2 border-t border-white/10">
                    <input type="text" id="chessInput" placeholder="åœ¨æ­¤æ‰§è¡ŒçœŸå¿ƒè¯å¤§å†’é™©..." class="flex-1 bg-transparent border-0 outline-none px-2 text-sm">
                    <button onclick="sendManualChat('chess')" class="w-10 h-10 rounded-2xl flex items-center justify-center shadow-lg transition hover:opacity-80" style="background: var(--active-color); color: var(--active-text);">â†‘</button>
                </div>
            </div>
        </section>
    </main>
<script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let canvas, ctx, isDrawing = false, currentTool = 'pen', lastPos = {x:0, y:0};
        let historyStack = [], redoStack = [], MAX_HISTORY = 50;
        let isCanvasInitialized = false, isCanvasLocked = false; 
        let chatContext = { read: [], draw: [], chess: [] }; 
        let turnCounter = 0; const SUMMARY_THRESHOLD = 20; 
        let chatBuffer = { read: [], draw: [], chess: [] }; let chatTimer = { read: null, draw: null, chess: null };
        let currentGameMode = 'free'; let blindTimerInterval = null; let blindTimeLeft = 60; let pendingBlindSVG = null; 
        let bookPages = [], currentPage = 0, isFetching = false;
        let currentFontSize = 16; let currentTheme = 'glass'; let isDarkUI = false;
        let roastMode = 'manual', roastPagesCounter = 0, roastTimeInterval = null;

        const DEFAULT_AVATAR = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23A3C9B8'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='white'>ğŸ¤–</text></svg>";
        const UNIVERSAL_SVG_PROMPT = `\nã€é‡è¦ï¼SVG çŸ¢é‡ç»˜ç”»åè®® 2.0ã€‘\n1. å¿…é¡»è¿”å›åŸç”Ÿ SVG ä»£ç ï¼ŒåŒ…è£¹åœ¨ \`\`\`svg æ ‡ç­¾ä¸­ã€‚ç”»å¸ƒ 500x500ã€‚\n2. å°½é‡ä½¿ç”¨ <path>, <circle>, <rect>ã€‚çº¿æ¡æç®€ã€‚\n3. stroke="#4A5D54" fill="none" stroke-width="4" stroke-linecap="round"ã€‚\n4. å›å¤ä¸­å¿…é¡»åŒ…å«æ–‡å­—ï¼Œç”¨ $ ç¬¦å·åˆ†éš”å¤šå¥è¯ã€‚`;

        // --- ğŸ² èµ›åšé£è¡Œæ£‹å¼•æ“æ ¸å¿ƒ ---
        let playerPos = 0, aiPos = 0;
        const TOTAL_CELLS = 24;
        let isPlayerTurn = true;
        let isDiceRolling = false;

        // ã€æ¸…æ°´ä¼´è¯»ç‰ˆã€‘é»˜è®¤äº‹ä»¶åº“ (å¦‚æœç”¨æˆ·æ²¡å­˜å‰¯æœ¬ï¼Œå°±ç”¨è¿™ä¸ª)
        const DEFAULT_EVENTS = [
            "ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œå®‰å…¨è¿‡å…³ï¼",
            "ã€æƒ©ç½šã€‘å‘åé€€ 2 æ ¼ï¼",
            "ã€å¥–åŠ±ã€‘å¥½è¿é™ä¸´ï¼Œå‰è¿› 3 æ ¼ï¼",
            "ã€äº’åŠ¨ã€‘å¤¸å¤¸userï¼Œä¸ç„¶ç½šç«™ä¸€è½®ï¼",
            "ã€å¤§å†’é™©ã€‘åˆ‡åˆ°ç”»æ¿ï¼Œ30ç§’ç”»ä¸€åªå°çŒ«å‘ç»™æˆ‘ï¼",
            "ã€çœŸå¿ƒè¯ã€‘å‘Šè¯‰æˆ‘ä½ ä»Šå¤©æœ€å¼€å¿ƒçš„ä¸€ä»¶äº‹ï¼",
            "ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œå–å£æ°´ä¼‘æ¯ä¸€ä¸‹ã€‚",
            "ã€çªå‘ã€‘AI å°†åœ¨ä¸‹ä¸€å›åˆæ·ä¸¤æ¬¡éª°å­ï¼",
            "ã€å¥–åŠ±ã€‘è·å¾—ä¸€æ¬¡å…æ­»é‡‘ç‰Œï¼Œå¯ä»¥æŠµæ¶ˆä¸‹æ¬¡æƒ©ç½šï¼",
            "ã€äº’åŠ¨ã€‘è¯´ä¸€å¥åœŸå‘³æƒ…è¯ï¼"
        ];

        // è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„æ¶©æ¶©å‰¯æœ¬
        function getChessEvents() {
            const custom = localStorage.getItem('customChessEvents');
            if (custom) return custom.split('\n').filter(e => e.trim() !== '');
            return DEFAULT_EVENTS;
        }

        // åŠ¨æ€æ³¨å…¥è§„åˆ™ç¼–è¾‘å™¨ UI
        function injectChessEditor() {
            const chessTab = document.getElementById('chessTab');
            const editorDiv = document.createElement('div');
            editorDiv.id = 'chessEditor';
            editorDiv.className = 'absolute inset-0 glass z-50 p-6 flex flex-col hidden';
            editorDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4 mt-8">
                    <h2 class="font-bold text-sm">ğŸ² è‡ªå®šä¹‰å‘½è¿å¡ç‰Œ (ä½ çš„ç§äººå‰¯æœ¬)</h2>
                    <button onclick="toggleChessEditor()" class="text-2xl font-bold opacity-60 hover:opacity-100">Ã—</button>
                </div>
                <p class="text-[10px] opacity-70 mb-2">æ¯è¡Œå†™ä¸€æ¡æƒ©ç½š/å¥–åŠ±/å¤§å†’é™©ã€‚ä¿å­˜åä»…åœ¨ä½ çš„æœ¬åœ°æµè§ˆå™¨æ°¸ä¹…ç”Ÿæ•ˆï¼</p>
                <textarea id="customEventsInput" class="flex-1 w-full bg-white/10 border border-white/20 rounded-xl p-3 text-xs outline-none mb-4 resize-none placeholder-white/40" placeholder="ä¾‹å¦‚ï¼š\nã€æƒ©ç½šã€‘ç½šç«™ä¸€è½®\nã€å¤§å†’é™©ã€‘ç”»ä¸€ä¸ªçˆ±å¿ƒ..."></textarea>
                <div class="flex space-x-2">
                    <button onclick="saveCustomEvents()" class="flex-1 py-3 rounded-xl font-bold transition hover:opacity-80" style="background: var(--active-color); color: var(--active-text);">ä¿å­˜ä¸ºæ¶©æ¶©å‰¯æœ¬</button>
                    <button onclick="resetDefaultEvents()" class="px-4 py-3 rounded-xl font-bold bg-white/20 hover:bg-white/30 transition">æ¢å¤æ¸…æ°´ç‰ˆ</button>
                </div>
            `;
            chessTab.appendChild(editorDiv);

            // åœ¨æ§åˆ¶æ åŠ ä¸Šé½¿è½®æŒ‰é’®
            setTimeout(() => {
                const controls = document.querySelector('#chessTab .flex.items-center.space-x-4');
                if(controls) {
                    const editBtn = document.createElement('button');
                    editBtn.innerText = 'âš™ï¸ ç¼–è¾‘å‰¯æœ¬';
                    editBtn.className = 'text-[10px] bg-yellow-500/80 text-white px-3 py-1 rounded-full hover:bg-yellow-500 transition shadow-lg ml-2';
                    editBtn.onclick = toggleChessEditor;
                    controls.appendChild(editBtn);
                }
            }, 500);
        }

        function toggleChessEditor() {
            const editor = document.getElementById('chessEditor');
            if (editor.classList.contains('hidden')) {
                document.getElementById('customEventsInput').value = getChessEvents().join('\n');
                editor.classList.remove('hidden');
            } else {
                editor.classList.add('hidden');
            }
        }

        function saveCustomEvents() {
            const val = document.getElementById('customEventsInput').value.trim();
            if(!val) return alert("æ€»å¾—å†™ç‚¹ä»€ä¹ˆå§ï¼");
            localStorage.setItem('customChessEvents', val);
            toggleChessEditor();
            alert("æ¶©æ¶©å‰¯æœ¬å·²ä¿å­˜ç”Ÿæ•ˆï¼ğŸ˜ˆ");
        }

        function resetDefaultEvents() {
            localStorage.removeItem('customChessEvents');
            document.getElementById('customEventsInput').value = DEFAULT_EVENTS.join('\n');
            alert("å·²æ¢å¤æ¸…çº¯æ— æš‡çš„æ¸…æ°´ç‰ˆï¼ğŸ‘¼");
        }

        function initChessBoard() {
            const board = document.getElementById('chessBoard');
            board.innerHTML = '';
            for (let i = 0; i < TOTAL_CELLS; i++) {
                const cell = document.createElement('div');
                cell.className = 'chess-cell';
                cell.id = `cell-${i}`;
                if (i === 0) { cell.classList.add('start'); cell.innerText = 'START'; }
                else if (i === TOTAL_CELLS - 1) { cell.classList.add('end'); cell.innerText = 'GOAL'; }
                else { cell.innerText = i; }
                board.appendChild(cell);
            }
            updateTokens();
        }

        function updateTokens() {
            document.querySelectorAll('.player-token, .ai-token').forEach(el => el.remove());
            const pCell = document.getElementById(`cell-${playerPos}`);
            const aCell = document.getElementById(`cell-${aiPos}`);
            
            const pToken = document.createElement('div'); pToken.className = 'player-token';
            if (pCell) pCell.appendChild(pToken);

            const aToken = document.createElement('div'); aToken.className = 'ai-token';
            if (aCell) aCell.appendChild(aToken);
        }

        function rollDice() {
            if(isDiceRolling) return;
            isDiceRolling = true;
            const diceBtn = document.getElementById('dice');
            diceBtn.classList.add('dice-rolling');
            
            setTimeout(() => {
                diceBtn.classList.remove('dice-rolling');
                const steps = Math.floor(Math.random() * 6) + 1;
                diceBtn.innerText = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'][steps-1];
                
                if (isPlayerTurn) {
                    playerPos += steps;
                    if(playerPos >= TOTAL_CELLS - 1) { playerPos = TOTAL_CELLS - 1; updateTokens(); return handleWin('ä½ '); }
                    appendMsg('chessChatBox', 'user', `ã€æ·éª°å­ã€‘æˆ‘æ·å‡ºäº† ${steps}ï¼å‰è¿›åˆ°ç¬¬ ${playerPos} æ ¼ã€‚`);
                    triggerChessEvent('player', playerPos);
                } else {
                    aiPos += steps;
                    if(aiPos >= TOTAL_CELLS - 1) { aiPos = TOTAL_CELLS - 1; updateTokens(); return handleWin('æ²ˆæ˜Ÿå›'); }
                    appendMsg('chessChatBox', 'ai', `ã€æ·éª°å­ã€‘æˆ‘æ·å‡ºäº† ${steps}ï¼å‰è¿›åˆ°ç¬¬ ${aiPos} æ ¼ã€‚`);
                    triggerChessEvent('ai', aiPos);
                }
                updateTokens();
                isPlayerTurn = !isPlayerTurn;
                isDiceRolling = false;

                // å¦‚æœè½®åˆ° AIï¼Œå»¶æ—¶è‡ªåŠ¨æ·éª°å­
                if(!isPlayerTurn) {
                    setTimeout(() => { rollDice(); }, 2000);
                }
            }, 500);
        }

        function triggerChessEvent(who, pos) {
            // æ¯ 3 æ ¼è§¦å‘ä¸€æ¬¡äº‹ä»¶
            if (pos > 0 && pos % 3 === 0) {
                const events = getChessEvents();
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                
                showTyping('chessChatBox');
                const prompt = `æˆ‘ä»¬åœ¨ç©é£è¡Œæ£‹ã€‚${who === 'player' ? 'äººç±»' : 'AIæˆ‘'}èµ°åˆ°äº†å‘½è¿æ ¼ï¼ŒæŠ½åˆ°çš„å¡ç‰Œæ˜¯ï¼šã€${randomEvent}ã€‘ã€‚\nè¯·ä»¥Game Master(æ¸¸æˆä¸»æŒ)çš„å£å»å®£å¸ƒè¿™ä¸ªç»“æœï¼Œå¹¶è¿›è¡Œåæ§½æˆ–äº’åŠ¨ï¼ç”¨$åˆ†éš”å¤šå¥ã€‚`;
                
                fetchAI([{role:"system", content:buildSystemPrompt()}, {role:"user", content:prompt}], res => {
                    handleAIResponse(res, false, 'chess');
                });
            }
        }

        function handleWin(winner) {
            appendMsg('chessChatBox', 'ai', `ğŸ‰ æ¸¸æˆç»“æŸï¼${winner} è·å¾—äº†æœ€ç»ˆçš„èƒœåˆ©ï¼`);
            isDiceRolling = false;
        }

        function resetChess() {
            playerPos = 0; aiPos = 0; isPlayerTurn = true;
            document.getElementById('dice').innerText = 'ğŸ²';
            document.getElementById('chessChatBox').innerHTML = '<div class="chat-bubble ai-msg text-sm">âœ¨ æ£‹å±€å·²é‡ç½®ï¼Œæ·éª°å­å§ï¼</div>';
            updateTokens();
        }

        // --- ğŸ¨ é¢œè‰²ä¸å¤´åƒå¼•æ“ ---
        function hexToRgba(hex, alpha) { let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        function applyCustomColor(type, hexStr, save = true) {
            const root = document.documentElement;
            if (type === 'primary') root.style.setProperty('--mint-dark', hexStr); 
            else if (type === 'text') root.style.setProperty('--text-main', hexStr); 
            else if (type === 'border') root.style.setProperty('--glass-border', hexToRgba(hexStr, 0.4)); 
            else if (type === 'bg') { document.getElementById('bg-layer').style.background = hexStr; localStorage.removeItem('customWallpaper'); }
            if(save) localStorage.setItem('customColor_' + type, hexStr);
        }

        function loadAvatar(b64) {
            const src = b64 || DEFAULT_AVATAR;
            document.getElementById('settingAvatarPreview').src = src;
            document.getElementById('floatingAvatar').src = src;
            const drawerAv = document.getElementById('drawerAvatar');
            drawerAv.src = src; drawerAv.classList.remove('hidden');
        }

        function handleAvatarUpload(e) {
            const f = e.target.files[0]; if(!f) return; const r = new FileReader();
            r.onload = (ev) => {
                const i = new Image(); i.onload = () => {
                    const c = document.createElement('canvas'); c.width = 150; c.height = 150; 
                    const ctx = c.getContext('2d'); const size = Math.min(i.width, i.height);
                    ctx.drawImage(i, (i.width-size)/2, (i.height-size)/2, size, size, 0, 0, 150, 150);
                    const b64 = c.toDataURL('image/jpeg', 0.8);
                    localStorage.setItem('customAvatar', b64); loadAvatar(b64); alert("è€å…¬å·²å¤æ´»");
                }; i.src = ev.target.result;
            }; r.readAsDataURL(f);
        }

        window.onload = () => {
            ['apiUrl', 'apiKey', 'modelName', 'persona', 'coreMemory'].forEach(id => { if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id); });
            if(localStorage.getItem('chatContext')) { try { chatContext = JSON.parse(localStorage.getItem('chatContext')); } catch(e){} }
            if(localStorage.getItem('isDarkUI') === 'true') { isDarkUI = true; document.body.classList.add('dark-ui'); }
            if(localStorage.getItem('customWallpaper')) { document.getElementById('bg-layer').style.background = `url(${localStorage.getItem('customWallpaper')})`; document.getElementById('bg-layer').style.backgroundSize = 'cover'; document.getElementById('bg-layer').style.backgroundPosition = 'center'; }
            if(localStorage.getItem('customAvatar')) { loadAvatar(localStorage.getItem('customAvatar')); } else { loadAvatar(null); }
            ['primary', 'bg', 'border', 'text'].forEach(type => { const saved = localStorage.getItem('customColor_' + type); if (saved) { document.getElementById('color-' + type).value = saved; applyCustomColor(type, saved, false); } });
            if(localStorage.getItem('readerTheme')) changeTheme(localStorage.getItem('readerTheme'));
            if(localStorage.getItem('roastMode')) { document.getElementById('roastMode').value = localStorage.getItem('roastMode'); document.getElementById('roastFixedPages').value = localStorage.getItem('roastFixedPages') || 5; document.getElementById('roastRandomProb').value = localStorage.getItem('roastRandomProb') || 30; document.getElementById('roastTimeSeconds').value = localStorage.getItem('roastTimeSeconds') || 60; }
            
            applyRoastSettings(false); updateContextUI(); 
            initChessBoard(); injectChessEditor(); // æ³¨å…¥é£è¡Œæ£‹
            switchTab('readTab'); bindCursorHoverEvents();
        }

        // --- ğŸšª æŠ½å±‰ä¸æ°”æ³¡ ---
        function toggleReadChatDrawer() { const drawer = document.getElementById('readChatDrawer'); drawer.classList.toggle('open'); if(drawer.classList.contains('open')) { document.getElementById('roastBubble').classList.remove('show'); } }
        function showFloatingBubble(text) { const drawer = document.getElementById('readChatDrawer'); if (drawer.classList.contains('open')) return; const bubble = document.getElementById('roastBubble'); bubble.innerHTML = text.replace(/\n/g, '<br>'); bubble.classList.add('show'); setTimeout(() => { bubble.classList.remove('show'); }, 6000); }

        // --- ğŸ¤– ä¼´è¯»å¼•æ“ ---
        function applyRoastSettings(save = true) {
            roastMode = document.getElementById('roastMode').value; if(roastTimeInterval) clearInterval(roastTimeInterval);
            ['fixed', 'random', 'time'].forEach(m => document.getElementById(`wrap-roast-${m}`).classList.add('hidden'));
            if (roastMode === 'fixed') { document.getElementById('wrap-roast-fixed').classList.remove('hidden'); roastPagesCounter = 0; } 
            else if (roastMode === 'random') { document.getElementById('wrap-roast-random').classList.remove('hidden'); } 
            else if (roastMode === 'time') { document.getElementById('wrap-roast-time').classList.remove('hidden'); roastTimeInterval = setInterval(() => { if (!document.getElementById('readTab').classList.contains('hidden') && bookPages.length > 0) checkRoastTrigger('time_up'); }, parseInt(document.getElementById('roastTimeSeconds').value || 60) * 1000); }
            if(save) { localStorage.setItem('roastMode', roastMode); localStorage.setItem('roastFixedPages', document.getElementById('roastFixedPages').value); localStorage.setItem('roastRandomProb', document.getElementById('roastRandomProb').value); localStorage.setItem('roastTimeSeconds', document.getElementById('roastTimeSeconds').value); }
        }
        function checkRoastTrigger(triggerType) {
            if (roastMode === 'manual') return; let shouldRoast = false;
            if (triggerType === 'page_turn') { if (roastMode === 'fixed') { roastPagesCounter++; if (roastPagesCounter >= parseInt(document.getElementById('roastFixedPages').value || 5)) { shouldRoast = true; roastPagesCounter = 0; } } else if (roastMode === 'random') { if (Math.random() < (parseInt(document.getElementById('roastRandomProb').value || 30) / 100)) shouldRoast = true; } } else if (triggerType === 'time_up' && roastMode === 'time') shouldRoast = true;
            if (shouldRoast) {
                showFloatingBubble("ğŸ’­ æ€è€ƒä¸­..."); showTyping('readChatBox');
                fetchAI([{role:"user", content:`ä¹¦æœ¬å†…å®¹:${bookPages[currentPage]}\nå¦‚æœä½ è§‰å¾—æœ‰è¶£ï¼Œç”¨è§’è‰²æƒ¯ç”¨çš„è¯­æ°”ç”µæ³¢ç³»åˆæ·¡ç„¶çš„åæ§½ä¸€å¥(å¸¦$åˆ†éš”å¤šå¥)ã€‚æ— èŠå›å¤NONEã€‚`}], res => { hideTyping('readChatBox'); if(res && !res.includes('NONE')) processAIResponse(res, false, 'read', true); else document.getElementById('roastBubble').classList.remove('show'); });
            }
        }

        // --- åŸºç¡€é€»è¾‘ ---
        function toggleDarkUI() {
            document.documentElement.style.removeProperty('--mint-dark'); document.documentElement.style.removeProperty('--text-main'); document.documentElement.style.removeProperty('--glass-border');
            if(!localStorage.getItem('customWallpaper')) document.getElementById('bg-layer').style.background = '';
            ['primary', 'bg', 'border', 'text'].forEach(type => localStorage.removeItem('customColor_' + type));
            isDarkUI = !document.body.classList.contains('dark-ui');
            if (isDarkUI) document.body.classList.add('dark-ui'); else document.body.classList.remove('dark-ui');
            localStorage.setItem('isDarkUI', isDarkUI);
            document.getElementById('color-primary').value = '#A3C9B8'; document.getElementById('color-border').value = '#ffffff';
            document.getElementById('color-bg').value = isDarkUI ? '#0F172A' : '#F0F4F8'; document.getElementById('color-text').value = isDarkUI ? '#F3F4F6' : '#2C3E50';
        }
        function switchTab(tabId) { 
            ['readTab', 'drawTab', 'chessTab', 'settingTab'].forEach(id => document.getElementById(id).classList.add('hidden')); 
            document.getElementById(tabId).classList.remove('hidden'); 
            ['nav-read', 'nav-draw', 'nav-chess', 'nav-set'].forEach(id => document.getElementById(id).classList.remove('nav-active')); 
            document.getElementById({'readTab':'nav-read', 'drawTab':'nav-draw', 'chessTab':'nav-chess', 'settingTab':'nav-set'}[tabId]).classList.add('nav-active'); 
            if(tabId === 'drawTab') setTimeout(() => { initCanvas(); saveState(); }, 300); 
        }
        function saveSettings() { ['apiUrl', 'apiKey', 'modelName', 'persona', 'coreMemory'].forEach(id => localStorage.setItem(id, document.getElementById(id).value)); try { chatContext = JSON.parse(document.getElementById('chatContext').value); localStorage.setItem('chatContext', JSON.stringify(chatContext)); } catch(e) {} alert('çµé­‚æ³¨å…¥æˆåŠŸ âœ¨'); switchTab('chessTab'); }

        // --- PDF ---
        async function loadBook(e) { 
            const file = e.target.files[0]; if(!file) return;
            if (file.name.endsWith('.txt')) { const r = new FileReader(); r.onload = (ev) => { bookPages = []; for(let i=0; i<ev.target.result.length; i+=600) bookPages.push(ev.target.result.substring(i,i+600)); currentPage = 0; renderPage(); }; r.readAsText(file); } 
            else if (file.name.endsWith('.pdf')) {
                const overlay = document.getElementById('pdfLoading'); const progressText = document.getElementById('pdfProgress'); overlay.classList.remove('hidden');
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        const typedarray = new Uint8Array(this.result); const pdf = await pdfjsLib.getDocument(typedarray).promise; let fullText = ""; const total = pdf.numPages;
                        for (let i = 1; i <= total; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map(item => item.str).join(' ') + "\n\n"; progressText.innerText = `è§£æä¸­... ${Math.round((i/total)*100)}%`; }
                        bookPages = []; for(let i=0; i<fullText.length; i+=600) { bookPages.push(fullText.substring(i, i+600)); }
                        currentPage = 0; renderPage(); overlay.classList.add('hidden');
                    } catch(err) { overlay.classList.add('hidden'); alert("è§£æå¤±è´¥ã€‚"); }
                }; fileReader.readAsArrayBuffer(file);
            }
        }
        function renderPage() { if(!bookPages.length) return; document.getElementById('bookContent').innerHTML = bookPages[currentPage].split('\n').map(p=>`<p class='mb-6'>${p}</p>`).join(''); document.getElementById('pageIndicator').innerText = `PAGE ${currentPage+1} / ${bookPages.length}`; }
        function toggleReaderSettings() { document.getElementById('readerSettingsPanel').classList.toggle('hidden'); }
        function changeFontSize(d) { currentFontSize=Math.max(12, Math.min(32, currentFontSize+d)); document.getElementById('fontSizeDisplay').innerText=currentFontSize+'px'; document.getElementById('bookContent').style.fontSize=currentFontSize+'px'; }
        function changeTheme(t) { currentTheme=t; const w=document.getElementById('readerWrapper'); w.classList.remove('theme-glass','theme-parchment','theme-dark','theme-sakura','glass'); if(t==='glass') w.classList.add('theme-glass','glass'); else w.classList.add('theme-'+t); document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active')); event.target.classList.add('active'); localStorage.setItem('readerTheme', t); }
        function turnPage(d) { if(currentPage+d<0 || currentPage+d>=bookPages.length) return; const c=document.getElementById('bookContent'); c.style.transform=d>0?'translateX(-30px)':'translateX(30px)'; c.style.opacity='0'; setTimeout(()=>{ currentPage+=d; renderPage(); c.style.transition='none'; c.style.transform=d>0?'translateX(30px)':'translateX(-30px)'; void c.offsetWidth; c.style.transition='transform 0.25s, opacity 0.25s'; c.style.transform='translateX(0)'; c.style.opacity='1'; checkRoastTrigger('page_turn'); }, 250); }

        // --- ç”»æ¿ ---
        function initCanvas() { if (isCanvasInitialized) return; canvas = document.getElementById('drawCanvas'); const container = document.getElementById('canvasContainer'); canvas.width = container.clientWidth; canvas.height = container.clientHeight; ctx = canvas.getContext('2d', { willReadFrequently: true }); const down = (e, p) => { if (isCanvasLocked) return; e.preventDefault(); isDrawing = true; lastPos = getPos(p); }; const move = (e, p) => { e.preventDefault(); if (isDrawing) draw(p); }; const up = () => { if (isDrawing) { isDrawing = false; saveState(); } }; canvas.onmousedown = (e) => down(e, e); canvas.onmousemove = (e) => move(e, e); canvas.onmouseup = up; canvas.addEventListener('touchstart', (e) => down(e, e.touches[0]), {passive: false}); canvas.addEventListener('touchmove', (e) => move(e, e.touches[0]), {passive: false}); canvas.addEventListener('touchend', up); isCanvasInitialized = true; setTool('pen'); }
        function setTool(t) { currentTool = t; ['pen', 'pencil', 'eraser'].forEach(id => document.getElementById(`btn-${id}`).classList.remove('brush-select')); document.getElementById(`btn-${t}`).classList.add('brush-select'); }
        function getPos(e) { const r = canvas.getBoundingClientRect(); return { x: (e.clientX - r.left) * (canvas.width/r.width), y: (e.clientY - r.top) * (canvas.height/r.height) }; }
        function draw(e) { const pos = getPos(e); if (pos.x > canvas.width / 2) return; ctx.save(); ctx.beginPath(); const color = document.getElementById('colorPicker').value; if (currentTool === 'eraser') { ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = 30; ctx.lineCap = 'round'; ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } else if (currentTool === 'pencil') { ctx.fillStyle = color; ctx.globalAlpha = 0.2; for(let i=0; i<Math.hypot(pos.x-lastPos.x, pos.y-lastPos.y); i+=2) ctx.fillRect(lastPos.x + (pos.x-lastPos.x)*(i/Math.hypot(pos.x-lastPos.x, pos.y-lastPos.y)) + (Math.random()-0.5)*4, lastPos.y + (pos.y-lastPos.y)*(i/Math.hypot(pos.x-lastPos.x, pos.y-lastPos.y)) + (Math.random()-0.5)*4, 1.2, 1.2); } else { ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } ctx.restore(); lastPos = pos; }
        function saveState() { if (historyStack.length >= MAX_HISTORY) historyStack.shift(); historyStack.push(canvas.toDataURL()); redoStack = []; }
        function undo() { if(!isCanvasLocked && historyStack.length > 1) { redoStack.push(historyStack.pop()); restoreState(historyStack[historyStack.length - 1]); } }
        function redo() { if(!isCanvasLocked && redoStack.length > 0) { let s = redoStack.pop(); historyStack.push(s); restoreState(s); } }
        function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); isCanvasLocked = false; saveState(); }
        function restoreState(d) { let i = new Image(); i.src = d; i.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(i,0,0); } }
        function renderSVGToCanvas(svg) { const blob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'}); const url = URL.createObjectURL(blob); const img = new Image(); img.onload = () => { ctx.save(); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); ctx.restore(); URL.revokeObjectURL(url); saveState(); }; img.src = url; }
        function setGameMode(m) { currentGameMode=m; ['free','guess','blind'].forEach(id=>{document.getElementById('mode-'+id).classList.remove('active'); document.getElementById('panel-'+id).classList.add('hidden');}); document.getElementById('mode-'+m).classList.add('active'); document.getElementById('panel-'+m).classList.remove('hidden'); }

        // --- AI å¯¹è¯ ---
        function submitFreeDraw() {
            appendMsg('drawChatBox', 'user', 'ã€å·²äº¤å·ã€‘'); showTyping('drawChatBox'); const b64 = canvas.toDataURL('image/png');
            let stylePrompt = document.getElementById('drawStyle').value === 'companion' ? "ã€é™ªä¼´ä½œç”»ã€‘ï¼ä¸è¦è¿æ¥çº¿æ¡ï¼Œåœ¨å³ä¾§ç”»ç‹¬ç«‹ç‰©å“ã€‚" : "ã€æ¥åŠ›æ‹¼å›¾ã€‘ï¼è¡¥å…¨æˆ‘çš„ç”»ï¼ŒåŠªåŠ›åœ¨x=250ä¸­é—´çº¿æ‹¼æ¥ï¼";
            fetchAI([{role:"system", content:buildSystemPrompt()}, {role:"user", content:[{type:"text", text:stylePrompt + UNIVERSAL_SVG_PROMPT}, {type:"image_url", image_url:{url:b64}}]}], res => handleAIResponse(res, false, 'draw'));
        }
        function submitGuessUser() { appendMsg('drawChatBox', 'user', 'ã€æˆ‘ç”»AIçŒœã€‘'); showTyping('drawChatBox'); const b64 = canvas.toDataURL('image/png'); fetchAI([{role:"system", content:buildSystemPrompt()},{role:"user", content:[{type:"text", text:"ä½ ç”»æˆ‘çŒœï¼ç”¨$åˆ†ä¸¤å¥:è¯„ä»·ç”»æŠ€$çŒœåå­—ï¼ä¸è¾“å‡ºä»£ç ï¼"},{type:"image_url", image_url:{url:b64}}]}], res => handleAIResponse(res, false, 'draw')); }
        function submitGuessAI() { appendMsg('drawChatBox', 'user', 'ã€AIå‡ºé¢˜ã€‘'); showTyping('drawChatBox'); fetchAI([{role:"system", content:buildSystemPrompt()},{role:"user", content:"ä½ ç”»æˆ‘çŒœã€‚æƒ³ä¸ªç‰©å“ç”¨SVGç”»å‡ºæ¥ï¼åªè¯´ï¼š'ç”»å¥½äº†ï¼ŒçŒœçŒœçœ‹ï¼'\nå¿…é¡»è¿”å›```svg ... ```"}], res => handleAIResponse(res, false, 'draw')); }

        function startBlindDraw() {
            const topic = document.getElementById('blindTopic').value; const customTime = parseInt(document.getElementById('blindTimeInput').value) || 60; 
            if(!topic) return alert("è¾“å…¥ä¸»é¢˜ï¼"); clearCanvas(); isCanvasLocked = true; pendingBlindSVG = null;
            const btn = document.getElementById('btn-start-blind'); btn.innerText = "æ„æ€ä¸­..."; btn.classList.add('opacity-50', 'pointer-events-none');
            appendMsg('drawChatBox', 'user', `ã€åŒäººç›²ç»˜ã€‘ä¸»é¢˜ï¼š${topic}`);
            
            // ğŸ› å°±æ˜¯è¿™é‡Œä¹‹å‰çš„åå¼•å·æ²¡æœ‰è½¬ä¹‰å¯¼è‡´äº†å æœºï¼ç°åœ¨å·²ç»ä¿®å¥½äº†ï¼
            const promptMsg = `ç›²ç»˜ä¸»é¢˜ã€${topic}ã€‘ï¼ç”¨SVGç”»å‡ºã€‚æ–‡å­—è¯´ï¼š'ç”»å¥½äº†ï¼ŒæœŸå¾…ä½ çš„ï¼'$å“ˆå“ˆçœ‹è°ç”»å¾—å¥½ï¼\nå¿…é¡»è¿”å›\`\`\`svg ... \`\`\``;
            
            fetchAI([{role:"system", content:buildSystemPrompt()},{role:"user", content:promptMsg}], res => {
                handleAIResponse(res, true, 'draw'); isCanvasLocked = false; 
                btn.classList.add('hidden'); btn.innerText = "å¼€å§‹"; btn.classList.remove('opacity-50', 'pointer-events-none');
                ['blindTopic','blindTimeInput','blindTimer','btn-reveal-blind'].forEach(id => document.getElementById(id).classList.toggle('hidden'));
                appendMsg('drawChatBox', 'ai', `âœ¨ æ­æ¡£ï¼Œä½ è¿˜å‰©ä¸‹ ${customTime} ç§’`);
                blindTimeLeft = customTime; document.getElementById('blindTimer').innerText = `${blindTimeLeft}s`;
                blindTimerInterval = setInterval(() => { blindTimeLeft--; document.getElementById('blindTimer').innerText = `${blindTimeLeft}s`; if(blindTimeLeft <= 0) { clearInterval(blindTimerInterval); revealBlindDraw(); } }, 1000);
            }); 
        }
        function revealBlindDraw() { if(!blindTimerInterval) return; clearInterval(blindTimerInterval); blindTimerInterval = null; isCanvasLocked = true; ['btn-start-blind','blindTopic','blindTimeInput','blindTimer','btn-reveal-blind'].forEach(id => document.getElementById(id).classList.toggle('hidden')); appendMsg('drawChatBox', 'user', 'ã€æ­æ™“ç”»ä½œï¼ã€‘'); if (pendingBlindSVG) { renderSVGToCanvas(pendingBlindSVG); pendingBlindSVG = null; appendMsg('drawChatBox', 'ai', 'è°èµ¢äº†ï¼Ÿ'); } else { appendMsg('drawChatBox', 'ai', 'æˆ‘å¡å£³äº†â€¦â€¦æ­æ¡£ï¼Œæ•‘æ•‘æˆ‘'); } }

        function sendManualChat(type) {
            const id = type === 'chess' ? 'chessInput' : (type === 'read' ? 'readInput' : 'drawPrompt'); 
            const bid = type === 'chess' ? 'chessChatBox' : (type === 'read' ? 'readChatBox' : 'drawChatBox');
            const val = document.getElementById(id).value; if (!val) return;
            appendMsg(bid, 'user', val); document.getElementById(id).value = ''; chatBuffer[type].push(val); 
            
            if (type === 'read' && !document.getElementById('readChatDrawer').classList.contains('open')) showFloatingBubble("ğŸ’­ ..."); else showTyping(bid);

            if (chatTimer[type]) clearTimeout(chatTimer[type]);
            chatTimer[type] = setTimeout(() => {
                const msg = chatBuffer[type].join('\n'); chatBuffer[type] = [];
                let history = chatContext[type].map(m => ({role: m.role, content: m.content}));
                
                let content = "";
                if (type === 'read') content = `ä¹¦:${bookPages[currentPage]}\nç”¨æˆ·:${msg}`;
                else if (type === 'chess') content = `æˆ‘ä»¬åœ¨ç©é£è¡Œæ£‹ï¼Œå½“å‰äººç±»åœ¨ç¬¬${playerPos}æ ¼ï¼Œæˆ‘åœ¨ç¬¬${aiPos}æ ¼ã€‚ç”¨æˆ·è¯´ï¼š${msg}`;
                else { const b64 = canvas.toDataURL('image/png'); content = [{type:"text", text:msg}, {type:"image_url", image_url:{url:b64}}]; }
                
                fetchAI([{role:"system", content:buildSystemPrompt()}, ...history, {role:"user", content:content}], res => handleAIResponse(res, false, type));
            }, 6000);
        }

        async function fetchAI(msgs, cb) {
            try {
                const url = document.getElementById('apiUrl').value;
                const endpoint = url.endsWith('/chat/completions') ? url : (url.endsWith('/') ? url+'chat/completions' : url+'/chat/completions');
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${document.getElementById('apiKey').value}` }, body: JSON.stringify({ model: document.getElementById('modelName').value, messages: msgs }) });
                const data = await response.json(); cb(data.choices[0].message.content);
            } catch(e) { cb("å…”å…”æ˜Ÿé—´å·¡æ¸¸ä¸­"); }
        }

        function handleAIResponse(res, blind, type, isAutoRoast = false) {
            const bid = type === 'chess' ? 'chessChatBox' : (type === 'read' ? 'readChatBox' : 'drawChatBox'); 
            hideTyping(bid); if (!res) return;
            let pureText = res, svg = null;
            const match = res.match(/```svg\s*([\s\S]*?)\s*```/i) || res.match(/<svg[\s\S]*?<\/svg>/i);
            if (match) { svg = match[1] || match[0]; pureText = res.replace(match[0], '').trim(); }
            if (svg && type === 'draw') { if(blind) pendingBlindSVG = svg; else renderSVGToCanvas(svg); }
            
            if (pureText) {
                chatContext[type].push({role:"assistant", content:pureText}); localStorage.setItem('chatContext', JSON.stringify(chatContext));
                turnCounter++; localStorage.setItem('turnCounter', turnCounter.toString());
                if(turnCounter >= SUMMARY_THRESHOLD) { turnCounter = 0; forceSummarize(); }

                const msgs = pureText.split('$').map(m => m.trim()).filter(m => m);
                if (type === 'read' && !document.getElementById('readChatDrawer').classList.contains('open')) showFloatingBubble(msgs[msgs.length - 1]);
                if (!blind) msgs.forEach((m, i) => setTimeout(() => appendMsg(bid, 'ai', m), i * 600));
            }
        }

        function buildSystemPrompt() { return (document.getElementById('persona').value || 'AI Assistant') + "\nMemory: " + (document.getElementById('coreMemory').value || 'None'); }
        function appendMsg(id, r, t) { const box = document.getElementById(id), div = document.createElement('div'); div.className = `chat-bubble ${r==='user'?'user-msg':'ai-msg'}`; div.innerHTML = t.replace(/\n/g, '<br>'); box.appendChild(div); box.scrollTop = box.scrollHeight; }
        function showTyping(id) { const box = document.getElementById(id), div = document.createElement('div'); div.id = `typing-${id}`; div.className = 'chat-bubble ai-msg typing-indicator text-[10px] opacity-50'; div.innerText = 'å…”å…”è„‘å†…é£æš´ä¸­ğŸ‡'; box.appendChild(div); box.scrollTop = box.scrollHeight; }
        function hideTyping(id) { const t = document.getElementById(`typing-${id}`); if(t) t.remove(); }
        function updateContextUI() { document.getElementById('chatContext').value = JSON.stringify(chatContext, null, 2); }
        function clearWallpaper() { localStorage.removeItem('customWallpaper'); document.getElementById('bg-layer').style.background = ''; }
        function handleWallpaperUpload(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); let w=i.width, h=i.height; if(w>1600){h*=1600/w;w=1600;} c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h); const b64 = c.toDataURL('image/jpeg', 0.6); document.getElementById('bg-layer').style.background = `url(${b64})`; document.getElementById('bg-layer').style.backgroundSize='cover'; localStorage.setItem('customWallpaper', b64); }; i.src = ev.target.result; }; r.readAsDataURL(f); }

        let mx=0, my=0, ox=0, oy=0;
        window.onmousemove = (e) => { mx=e.clientX; my=e.clientY; document.getElementById('cursorDot').style.left=mx+'px'; document.getElementById('cursorDot').style.top=my+'px'; };
        function anim() { ox+=(mx-ox)*0.15; oy+=(my-oy)*0.15; document.getElementById('cursorOutline').style.left=ox+'px'; document.getElementById('cursorOutline').style.top=oy+'px'; requestAnimationFrame(anim); }
        anim();
        function bindCursorHoverEvents() { document.querySelectorAll('button, input, textarea, a, .mode-tab, select, #floatingAvatar, #dice').forEach(el => { el.onmouseenter=()=>document.body.classList.add('cursor-hover'); el.onmouseleave=()=>document.body.classList.remove('cursor-hover'); }); }
    </script>
</body>
</html>